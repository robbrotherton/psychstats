---
title: Correlation
subtitle: The consistency of deviations
crossref: false
---


::: {#container style="text-align: center; margin: 1em;"}
:::


<div class="controls" style="text-align: center; margin: 1em;">

<label for="target-r" class="form-label">Strength of correlation</label>
<div style="width: 100%;">
  <span style="margin-right: 10px;">-1</span>
  <input id="target-r" type="range" class="form-range" min=-1 max=1 step=0.01 style="width: 80%; flex-grow: 1;">
  <span style="margin-left: 10px;">1</span>
</div>


<div style="margin-top: 5px;">
  <input type="checkbox" id="show-deviation-lines" checked>
  <label for="show-deviation-lines">Show deviation lines</label>
</div>

<div style="margin-top: 5px;">
<input type="checkbox" id="show-rectangles" checked>
<label for="show-rectangles">Show deviation rectangles</label>
</div>
</div>

<style>
  input[type=checkbox] {
    margin-right: 1em;
    vertical-align: text-top;
  }
  .label {
    vertical-align: middle;
  }
</style>

<!-- ## About

Correlation is about the consistency of deviations. -->


```{ojs}
//| echo: false
jStat = require("https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js")

chart = {

const width = 500
const height = 400


const xScale = d3.scaleLinear()
  .domain([-0.1, 1.1])
  .range([0, width])
let yScale = d3.scaleLinear()
  .domain([0, 1])
  .range([height, 0])


  
const svg = d3.select("#container").append("svg")
  .attr("width", width)
  .attr("height", height)
  
const meanLines = svg.append("g")
const axisLines = svg.append("g")

axisLines.append("line")
  .attr("class", "axis-line")
  .attr("x1", 1).attr("x2", width)
  .attr("y1", height - 1).attr("y2", height - 1)
  .style("stroke", "black")
axisLines.append("line")
  .attr("class", "axis-line")
  .attr("x1", 1).attr("x2", 1)
  .attr("y1", height - 1).attr("y2", 1)
  .style("stroke", "black")

// variables for viz options
let showRectangles = true;
let showDeviationLines = true;

// inputs for viz options
const rInput = d3.select("#target-r");
const rectanglesToggle = d3.select("#show-rectangles");
const deviationLinesToggle = d3.select("#show-deviation-lines");

rInput.on("input", () => updateChart(rInput.property("value")));

rectanglesToggle.on("change", function() {
  showRectangles = this.checked;
  updateChart(rInput.property("value"));
});

deviationLinesToggle.on("change", function() {
  showDeviationLines = this.checked;
  updateChart(rInput.property("value"));
});

let data = makeInitialData(10);
  


function makeInitialData(n) {
    let arr = [];
    for (var i = 0; i < n; i++) {
        var A = Math.random();
        var B = Math.random();
        arr.push({xVal: A, y0: B});
    }

    let xMin = Math.min(...arr.map(obj => obj.xVal));
    let xMax = Math.max(...arr.map(obj => obj.xVal));
    
    // Normalize the x-values to the range 0 to 1.
    for (let i = 0; i < arr.length; i++) {
        arr[i].xVal = (arr[i].xVal - xMin) / (xMax - xMin);
    }
    
    let meanX = jStat.mean(arr.map(obj => obj.xVal));
    
    // Adjust x-values to have a mean of 0.5.
    const desiredMeanX = 0.5;
    for (let i = 0; i < arr.length; i++) {
        arr[i].xVal = arr[i].xVal - meanX + desiredMeanX;
    }

    return arr;
}

function computeYValue(x, y, r) {
 return x * r + y * Math.pow(1 - Math.pow(r, 2), 0.5);
}


function updateChart(targetR) {
  
  let newData = [];
  
  for (let i = 0; i < data.length; i++) {
    newData.push({
      xVal: data[i].xVal,
      yVal: computeYValue(data[i].xVal, data[i].y0, targetR)
    });
  }
  
  let yLimits = [
    -0.1, 1.1
  ];

  let yMin = Math.min(...newData.map(obj => obj.yVal));
  let yMax = Math.max(...newData.map(obj => obj.yVal));
  
  // Normalize the y-values to the range 0 to 1.
  for (let i = 0; i < newData.length; i++) {
    newData[i].yVal = (newData[i].yVal - yMin) / (yMax - yMin);
  }
  
  let meanY_ = jStat.mean(newData.map(obj => obj.yVal));
  
  // Adjust y-values to have a mean of 0.5.
  const desiredMeanY = 0.5;
  for (let i = 0; i < newData.length; i++) {
    newData[i].yVal = newData[i].yVal - meanY_ + desiredMeanY;
    <!-- newData[i].yVal = Math.max(0, Math.min(1, newData[i].yVal)); -->
  }
  
  
  yScale.domain(yLimits);
  <!-- yScale.domain(yLimits); -->
  
  svg.selectAll("circle").remove()
  svg.selectAll("circle").data(newData).enter().append("circle")
    .attr("cx", d => xScale(d.xVal))
    .attr("r", 5)
    .attr("cy", d => yScale(d.yVal));
    
  let xArr = newData.map(obj => obj.xVal);
  let yArr = newData.map(obj => obj.yVal);
  
  let meanX = jStat.mean(xArr);
  let meanY = jStat.mean(yArr);
  
  meanLines.selectAll("line").remove()
  meanLines.append("line")
    .attr("x1", xScale(0)).attr("x2", xScale(1))
    .attr("y1", yScale(meanY)).attr("y2", yScale(meanY))
    .attr("stroke", "black")
    .attr("stroke-width", 2)
    .attr("stroke-dasharray", [5,5])
  meanLines.append("line")
    .attr("x1", xScale(meanX)).attr("x2", xScale(meanX))
    .attr("y1", yScale(yLimits[0] + 0.1)).attr("y2", yScale(yLimits[1] - 0.1))
    .attr("stroke", "black")
    .attr("stroke-width", 2)
    .attr("stroke-dasharray", [5,5])
    
  drawDeviationPolygons(meanX, meanY, yLimits);
  
  let actualR = jStat.corrcoeff(xArr, yArr);
  console.log("target r: " + targetR);
  console.log("actual r: " + actualR);
  
}

// Step 1: Add new state variable to track if deviation lines are shown
function drawDeviationPolygons(meanX, meanY, yLimits) {
    // Clear previous polygons and lines
    meanLines.selectAll("polygon").remove();
    meanLines.selectAll(".deviation-line").remove();
    
    // Get all circles (data points)
    svg.selectAll("circle").each(function(d) {
        const point = d3.select(this);
        const x = +point.attr("cx");
        const y = +point.attr("cy");
        
        // Calculate deviations
        const xDeviation = d.xVal - meanX;
        const yDeviation = d.yVal - meanY;
        const sameDirection = (xDeviation * yDeviation) > 0;
        
        // Determine colors based on deviation directions
        const xDeviationColor = xDeviation > 0 ? "green" : "red";
        const yDeviationColor = yDeviation > 0 ? "green" : "red";
        
        // Draw deviation lines only if the toggle is checked
        if (showDeviationLines) {
            // Draw X deviation line
            meanLines.append("line")
                .attr("class", "deviation-line")
                .attr("x1", x)
                .attr("x2", xScale(meanX))
                .attr("y1", y)
                .attr("y2", y)
                .attr("stroke", xDeviationColor)
                .attr("stroke-width", 1)
                .attr("stroke-dasharray", "2,2");
                
            // Draw Y deviation line
            meanLines.append("line")
                .attr("class", "deviation-line")
                .attr("x1", x)
                .attr("x2", x)
                .attr("y1", y)
                .attr("y2", yScale(meanY))
                .attr("stroke", yDeviationColor)
                .attr("stroke-width", 1)
                .attr("stroke-dasharray", "2,2");
        }
            
        // Only create rectangles if toggle is checked
        if (showRectangles) {
          svg.selectAll(".deviation-line")
            .attr("stroke", "grey")
            meanLines.append("polygon")
                .attr("points", [
                    [x, y],
                    [x, yScale(meanY)],
                    [xScale(meanX), yScale(meanY)],
                    [xScale(meanX), y]
                ])
                .attr("fill", sameDirection ? "green" : "red")
                .attr("opacity", 0.1);
        }
    });
    
    // Keep the mean lines
    meanLines.append("line")
        .attr("x1", xScale(0))
        .attr("x2", xScale(1))
        .attr("y1", yScale(meanY))
        .attr("y2", yScale(meanY))
        .attr("stroke", "black")
        .attr("stroke-dasharray", "5,5");
        
    meanLines.append("line")
        .attr("x1", xScale(meanX))
        .attr("x2", xScale(meanX))
        .attr("y1", yScale(yLimits[0] + 0.1))
        .attr("y2", yScale(yLimits[1] - 0.1))
        .attr("stroke", "black")
        .attr("stroke-dasharray", "5,5");
}

updateChart(rInput.property("value"));

}


```